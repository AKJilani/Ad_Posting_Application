{% extends 'base.html' %}
{% block title %}
Apartments for Rent
{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ad_apartment.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
{% endblock %}

{% block content %}
<a href="/post_ad" class="btn-edit-dlt-etc btn btn-primary mb-3">Post New Ad</a>

<div class="listings-container-user-dashboard">
    {% for ad in ads %}
    <!-- Apartment Card -->
    <div class="apartment-card" id="card-{{ ad.Id }}">
        <div class="card-header">
            <button
            onclick="window.location.href='/edit_ad_flat/{{ ad.Id }}'"
            class="btn-edit-dlt-etc btn btn-primary btn-sm edit-btn-ad-flat-{{ ad.Id }}"> Edit</button>
            <button class="btn-edit-dlt-etc btn btn-primary btn-sm delete-btn-ad-flat-{{ ad.Id }}"
                onclick="deleteAd('{{ ad.Id }}')">Delete</button>
            <button class="btn-edit-dlt-etc btn btn-primary btn-sm not-available-btn-ad-flat-{{ ad.Id }}"
                onclick="markAsNotAvailable('{{ ad.Id }}')">Mark as Not
                Available</button>
            <button class="btn-edit-dlt-etc btn btn-primary btn-sm available-btn-ad-flat-{{ ad.Id }}"
                onclick="markAsAvailable('{{ ad.Id }}')">Mark as
                Available</button>
            <div class="ad-title-active-status-div">
                <h2 class="card-title" style="margin-bottom: 5px; margin-top: 5px;">Apartment for Rent</h2>
                <h6>
                    Status: 
                    {% if ad.Ad_Active_Status == 0 %}
                        <span style="color: green; font-weight: bold;">Active</span>
                    {% else %}
                        <span style="color: red; font-weight: bold;">InActive</span>
                    {% endif %}
                </h6>                
            </div>
            <div class="full-address">
                <i class="fas fa-map-marker-alt"></i> {{ ad.Address }}
            </div>
        </div>

        <div class="card-highlights">
            <div class="card-price">
                <span class="price-amount">{{ "{:,.0f}".format(ad.Rent_Per_Month) }}</span>
                <span class="price-period">/month</span>
            </div>

            <div class="quick-features">
                <span><i class="fas fa-bed"></i>{{ ad.Bedrooms }}</span>
                <span><i class="fas fa-bath"></i>{{ ad.Bathrooms }}</span>
                <span><i class="fas fa-parking" style="margin-top: 2.5px;"></i>Parking: {{ ad.Parking }}</span>
            </div>
        </div>

        <div class="card-actions">
            <a class="call-btn" href="tel:{{ ad.Phone_Number }}">
                <i class="fas fa-phone"></i> {{ ad.Phone_Number }}
            </a>
            <button class="details-btn" onclick="openModal('{{ ad.Id }}')">
                <i class="fas fa-info-circle"></i> See Details
            </button>
        </div>
    </div>
    {% endfor %}
</div>

{% if not ads %}
<div class="no-ads-message">
    <h3>No Ads Available</h3>
    <p>It seems there are no ads available at the moment. Please check back later or post a new ad.</p>
</div>
{% endif %}

<!-- Modal Template -->
{% for ad in ads %}
<div id="modal-{{ ad.Id }}" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('{{ ad.Id }}')">&times;</span>
        <h3 class="modal-title">Apartment Details</h3>

        <div class="modal-grid">
            <div class="modal-detail-item">
                <span class="modal-detail-label">Building:</span>
                <span>{{ ad.Building_Number }}</span>
            </div>
            <div class="modal-detail-item">
                <span class="modal-detail-label">Apartment:</span>
                <span>{{ ad.Apartment_Number }}</span>
            </div>
            <div class="modal-detail-item">
                <span class="modal-detail-label">Available From:</span>
                <span>{{ ad.Available_From_Date }}</span>
            </div>
            <div class="modal-detail-item">
                <span class="modal-detail-label">Advance Payment:</span>
                <span>{{ "{:,.0f}".format(ad.Advance_Payment) }}</span>
            </div>
            <div class="modal-detail-item">
                <span class="modal-detail-label">Rent:</span>
                <span>{{ "{:,.0f}".format(ad.Rent_Per_Month) }} /month</span>
            </div>
            <div class="modal-detail-item">
                <span class="modal-detail-label">Address:</span>
                <span>{{ ad.Address }}</span>
            </div>
        </div>

        <div class="modal-section">
            <h4 class="modal-section-title">Features</h4>
            <div class="modal-features">
                <div class="modal-feature-item"><i class="fas fa-users"></i>{{ ad.Tenant_Type }}</div>
                <div class="modal-feature-item"><i class="fas fa-bed"></i>{{ ad.Bedrooms }} Bedrooms</div>
                <div class="modal-feature-item"><i class="fas fa-bath"></i>{{ ad.Bathrooms }} Bathrooms</div>
                <div class="modal-feature-item"><i class="fas fa-parking"></i>Parking: {{ ad.Parking }}</div>
            </div>
        </div>

        <div class="modal-section">
            <h4 class="modal-section-title">Restrictions</h4>
            <p>{{ ad.Restrictions }}</p>
        </div>

        <div class="modal-section">
            <h4 class="modal-section-title">Description</h4>
            <p>{{ ad.Description }}</p>
        </div>
    </div>
</div>
{% endfor %}

{% block js %}
<script>
    // Open modal function
    function openModal(adId) {
        document.getElementById(`modal-${adId}`).style.display = "block";
        document.body.style.overflow = "hidden"; // Prevent scrolling when modal is open
    }

    // Close modal function
    function closeModal(adId) {
        document.getElementById(`modal-${adId}`).style.display = "none";
        document.body.style.overflow = "auto"; // Restore scrolling
    }

    // Close modal when clicking outside of it
    window.onclick = function (event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
            document.body.style.overflow = "auto";
        }
    }

    // Close modal with escape key
    document.addEventListener('keydown', function (event) {
        if (event.key === "Escape") {
            const modals = document.getElementsByClassName('modal');
            for (let i = 0; i < modals.length; i++) {
                if (modals[i].style.display === "block") {
                    modals[i].style.display = "none";
                    document.body.style.overflow = "auto";
                }
            }
        }
    });

    // Add hover effect to show "See Details" more prominently
    document.addEventListener('DOMContentLoaded', function () {
        const cards = document.querySelectorAll('.apartment-card');

        cards.forEach(card => {
            const btn = card.querySelector('.details-btn');

            card.addEventListener('mouseenter', function () {
                btn.style.backgroundColor = '#007bff';
                btn.style.color = 'white';
            });

            card.addEventListener('mouseleave', function () {
                btn.style.backgroundColor = '';
                btn.style.color = '';
            });
        });
    });
    // Function to delete ad
    function deleteAd(adId) {
        if (!confirm("Are you sure you want to delete this ad?")) return;

        fetch(`/delete_ad_flat/${adId}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`card-${adId}`).remove();
                } else {
                    alert("Failed to delete ad.");
                }
            });
    }
    //Function to mark as available ad
    function markAsAvailable(adId) {
        fetch(`/mark_available_flat/${adId}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("Marked as available.");
                } else {
                    alert("Failed to mark as available.");
                }
            });
    }
    //Function to mark as Not availabel ad
    function markAsNotAvailable(adId) {
        fetch(`/mark_not_available_flat/${adId}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("Marked as not available.");
                } else {
                    alert("Failed to mark as not available.");
                }
            });
    }

</script>
{% endblock %}
{% endblock %}